syntax = "proto3";

package vstorepb;


message SecondaryIndexPropertyConfig {

    message ElasticsearchField {
        string name = 1;
        string type = 2;
        string index = 3;
        string analyzer = 4;
    }
    // Elasticsearch Property Config
    message Elasticsearch {
        string type = 1;
        string index = 2;
        bool exclude = 4;

        // Allows fields to be stored multiple times with different analyzers
        repeated ElasticsearchField fields = 3;

    }

    message CloudSQL {
        string type = 1;
        bool exclude = 2;
    }

    oneof config {
        Elasticsearch elasticsearch_property_config = 1;
        CloudSQL cloudsql_property_config = 2;
    }
}


message SecondaryIndex {

    // Name of the secondary index, this name must be unique from other secondary indexes
    string name = 1;

    // Index configuration and denotes the type of the secondary index as well.
    oneof index {
        ElasticsearchRawConfig es_raw_config = 2; // Deprecated.
        ElasticsearchConfig es_config = 3;
        CloudSQLConfig cloud_sql_config = 4;
        PubSubConfig pubsub_config = 5;
        BigQueryConfig big_query_config = 6;
    }
}

// ElasticsearchRawConfig is deprecated and will be removed in a future release.
message ElasticsearchRawConfig {
    string mapping_json = 1;
    string settings_json = 2;
    string index_name = 3;
}

// ElasticsearchConfig uses our proprietary clusters as a destination for your indices.
// If you specify an ElasticsearchCluster, VStore will instead use that cluster as a destination.
message ElasticsearchConfig {
    int64 number_of_shards = 1;
    int64 number_of_replicas = 2;
    string refresh_interval = 3;
    ElasticsearchAnalysis analysis = 4;
    string index_name = 5;
    ElasticsearchCluster cluster = 6;
}

message CloudSQLConfig {
    string index_name = 1;
    string instance_ip = 2;
    string user_name = 3;
    string password = 4;
    bytes client_key = 5;
    bytes client_cert = 6;
    bytes server_certificate_authority = 7;
    string project_id = 8;
    string instance_name = 9;
}

message PubSubConfig {
    string index_name = 1;
}

message BigQueryConfig {
    string index_name = 1;
}

// https://www.elastic.co/guide/en/elasticsearch/guide/current/custom-analyzers.html
message ElasticsearchAnalysis {
    repeated ElasticsearchAnalyzer analyzers = 1;
    repeated ElasticsearchFilter filters = 2;
    repeated ElasticsearchCharFilter char_filters = 3;
    repeated ElasticsearchTokenizer tokenizers = 4;
}

// ElasticsearchAnalyzer configures a custom analyzer that can be built to transform your data into a
// configuration that suites your particular needs.
message ElasticsearchAnalyzer {
    string name = 1;
    string type = 2;
    repeated string stem_exclusion = 3;
    repeated string stop_words = 4;
    repeated string char_filter = 5;
    string tokenizer = 6;
    repeated string filter = 7;
}

// Token filters may change, add, or remove tokens.
message ElasticsearchFilter {
    string name = 1;
    string type = 2;
    string pattern = 3;
    string replacement = 4;
    repeated string synonyms = 5;
}

// Character filters are used to “tidy up” a string before it is tokenized.
message ElasticsearchCharFilter {
    string name = 1;
    string type = 2;
    string pattern = 3;
    string replacement = 4;
}

// The tokenizer breaks up the string into individual terms or tokens.
message ElasticsearchTokenizer {
    string name = 1;
    string type = 2;
    string delimiter = 3;
    string pattern = 4;
}

// ElasticsearchCluster contains information necessary for VStore to communicate with an arbitrary ES Cluster
// VStore needs to be authed as a user with full CRUD permissions
message ElasticsearchCluster {
    string host_name = 1;
    string username = 2;
    string password = 3;
}
