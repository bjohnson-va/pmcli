syntax = "proto3";

package vetl.v1;

// Describes the destination for a transform's output
message DataSink {
    // The Sink contains all the metadata necessary for vETL to write data to a particular destination
    oneof sink {
        VStoreSink vstore = 1;
        TesseractSink tesseract = 2;
    }
}

// TesseractSink contains the necessary information for vETL to be able to write data to a particular Tesseract table
message TesseractSink {
    string namespace = 1;
    string kind = 2;
    repeated string primary_key = 3;

    // Provides concurrency control through a monotonically increasing version number
    message VersionConcurrencyControl {
        string version_field = 1;
    }

    // Provides concurrency control through a timestamp based approach
    message LastModifiedConcurrencyControl {
        string last_modified_field = 1;
    }

    // Sets how the concurrency control for this table is managed
    oneof concurrency_control {
        VersionConcurrencyControl version_concurrency_control = 10;
        LastModifiedConcurrencyControl last_modified_concurrency_control = 11;
    }
}

// VStoreSink contains the necessary information for vETL to be able to write data to a particular VStore table
message VStoreSink {
    string namespace = 1;
    string kind = 2;
    repeated string primary_key = 3;

    message SecondaryIndex {

        // Name of the secondary index, this name must be unique from other secondary indexes
        string name = 1;

        message CloudSQLConfig {
            string index_name = 1;
            string instance_ip = 2;
            string user_name = 3;
            string password = 4;
            bytes client_key = 5;
            bytes client_cert = 6;
            bytes server_certificate_authority = 7;
            string project_id = 8;
            string instance_name = 9;
        }

        // Index configuration and denotes the type of the secondary index as well.
        oneof index {
            CloudSQLConfig cloud_sql_config = 2;
        }
    }

    repeated SecondaryIndex secondary_indexes = 4;
}