syntax = "proto3";

package iam.v1;

import "google/protobuf/empty.proto";
import "subjects.proto";
import "resources.proto";
import "google/api/annotations.proto";

// Creates and manages Subject objects.
//
// A Subject is a multi persona object keyed by the email.  A subject can contain many personas that are namespaced
// by either a type/namespace or a type context.  Examples are:
// 1) A typed context is a persona that is scoped to a Partner user. Example: {type: partner}
// 2) A type/namespace context is a persona that is scoped to a SMB user. Example: {type: smb, namespace:VMF}
//
// Since emails are the unique identifier, each persona has an identifier that is globally unique across
// all personas.  This allows getting a specific persona without knowing the context.  It also allows each persona
// to have its own set of metadata such as names as well as its own passwords.  This ensures that namespaced
// personas with the same type can be used across several namespaces with different passwords and different metadata.
// Specifically, this ensures that partners can NOT affect personas that are not associated to their partner id.

service IAM {
    // Registers a subject with IAM, if the supplied context is already used, an already exists error will be returned.
    rpc RegisterSubject (RegisterSubjectRequest) returns (RegisterSubjectResponse){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Authenticate subject takes a context, email and password and validates the password is correct. No response
    // is returned but an OK status indicates a successful authentication, while an Unauthenticated response will
    // be returned on a missing subject/persona, the persona is locked, or the password is not correct.
    //
    // Multiple authentication attempts with the incorrect password will lock the persona for a short time period.
    // This is to prevent a brute-force attempt at authenticating a user.
    rpc AuthenticateSubject (AuthenticateSubjectRequest) returns (google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Returns a list of subject personas by their subject IDs. The request is scoped to a specific context.
    rpc GetSubjects(GetSubjectsRequest) returns (GetSubjectsResponse){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Returns a list of subject personas by their emails. The request is scoped to a specific context.
    rpc GetSubjectsByEmail(GetSubjectsByEmailRequest) returns (GetSubjectsResponse){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Will update/set/delete a subject personas attributes by its subject ID. Will return a not found error if the
    // subject persona doesn't exist.
    rpc MutateAttributes (MutateAttributesRequest) returns (google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Will set a given subject personas password.
    rpc ResetSubjectPassword (ResetSubjectPasswordRequest) returns (google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Will change the email of a given subject persona.
    rpc ChangeSubjectEmail (ChangeSubjectEmailRequest) returns (google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Will delete the persona from a given subject.
    rpc DeleteSubject (DeleteSubjectRequest) returns (google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Will search across a specified context. Cross context searching is not supported.
    rpc SearchSubject (SearchSubjectRequest) returns (SearchSubjectResponse){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Given a subject ID, will return the context that is associated to this persona.
    // Specifically, this is useful for getting the partner id from a user ID, if the user is in a type/namespace
    // context.
    rpc GetSubjectContext (GetSubjectContextRequest) returns (GetSubjectContextResponse){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Registers a resource owner with IAM. This sets an application up for integration with IAM access control system.
    rpc RegisterResourceOwner (RegisterResourceOwnerRequest) returns (google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Registers a specific resource with IAM. This allows IAM to ask the resource owner about its resources.
    rpc RegisterResource (RegisterResourceRequest) returns (google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    //Registers a policy associated with a resource with IAM that is evaluated whenever a subject requests access to that type of resource.
    rpc RegisterPolicy (RegisterPolicyRequest) returns (google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    //Asks IAM whether a certain subject has access to a certain resource
    rpc AccessResource (AccessResourceRequest) returns(google.protobuf.Empty){
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };
    
    // Asks IAM for a short lived token for a specific user.
    // This is a temporary endpoint until we back VBC, Marketplace, and SSC sessions by IAM.
    rpc GetShortLivedToken (GetShortLivedTokenRequest) returns(GetTokenResponse){
        option deprecated = true;
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };
    
}

// UserIAM are methods that are callable by users from the frontend without a service account.  These methods require that the subject is authenticated and has 
// a valid session/cookie with IAM.
service UserIAM {
    // Gets the subject from the given session
    rpc GetSubjectBySession(GetSubjectBySessionRequest) returns (GetSubjectResponse) {
        option (google.api.http) = {
            post: "/v1/report-data/create"
            body: "*"
        };
    };

    // Returns a short lived token that can be used to issue requests to other vendasta APIs.
    rpc GetToken(GetTokenRequest) returns (GetTokenResponse) {
        option (google.api.http) = {
            post: "/v1/report-data/asdf"
            body: "*"
        };
    };
}
